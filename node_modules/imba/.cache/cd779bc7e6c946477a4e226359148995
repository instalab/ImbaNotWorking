var Imba = require('imba'), _1 = Imba.createElement;
var ExplorerView = require('./ExplorerView').ExplorerView;
var DependenciesPanel = require('./DependenciesPanel').DependenciesPanel;
var SidebarPanel = require('./SidebarPanel').SidebarPanel;
var WidgetPanel = require('./WidgetPanel').WidgetPanel;
var SlidesPanel = require('./SlidesPanel').SlidesPanel;
var BranchesPanel$ = require('./BranchesPanel'), BranchesPanel = BranchesPanel$.BranchesPanel, BranchEntry = BranchesPanel$.BranchEntry;

var SpaceMenu = require('./SpaceMenu').SpaceMenu;
var uxa$ = require('uxa'), IconButton = uxa$.IconButton, Dialog = uxa$.Dialog, TextField = uxa$.TextField, Button = uxa$.Button;

// Should move somewhere else
var LogEntry = require('../widgets/browser/PlayerPage').LogEntry;
var ScrimbaGesture = require('../util/ScrimbaGesture').ScrimbaGesture;
var CastDialog = require('../../site/components/CastDialog').CastDialog;

var Resizer = Imba.defineTag('Resizer', function(tag){
	
	tag.prototype.ontouchstart = function (t){
		return ScrimbaGesture.wrap(t);
	};
	
	tag.prototype.onresizestart = function (g){
		return g._width = this.data().width();
	};
	
	tag.prototype.onresizeupdate = function (g){
		var v_;
		return (this.data().setWidth(v_ = g.clamp(100,g._width + g.dx(),320,10)),v_);
	};
});

var SidebarView = Imba.defineTag('SidebarView', function(tag){
	
	tag.prototype.setup = function (){
		var v_;
		return (this.setSref(v_ = this.data().id()),v_);
	};
	
	tag.prototype.space = function (){
		return this.data().space();
	};
	
	tag.prototype.showMenu = function (e){
		return e.uxa().open((_1(SpaceMenu).flag('sm')).bindData(this,'space',[]).end());
	};
	
	tag.prototype.editMetadata = function (){
		return this.uxa().open((_1(CastDialog).flag('modal')).bindData(this.space(),'model',[]).setFormData(this.space().model()).end());
	};
	
	tag.prototype.render = function (){
		var $ = this.$;
		return this.$open(0).setChildren($.$ = $.$ || [
			// <.top-shadow>
			_1(Resizer,$,0,this).flag('resizer').flag('right').dataset('gesture','resize'),
			_1('section',$,1,this).flag('main').setContent([
				_1('header',$,2,1).flag('header'),
				_1(ExplorerView,$,6,1),
				_1(DependenciesPanel,$,7,1)
			],2)
		],2).synced((
			$[0].bindData(this,'data',[]).end(),
			$[2].setContent([
				($[3] || _1('div',$,3,2).flag('title').setText("Project")),
				this.space().model().can(this.api().user(),'edit') ? (
					($[4] || _1('div',$,4,2).flag('tool').flag('edit').dataset('icon','medit').on$(0,['tap','editMetadata'],this)).end()
				) : void(0),
				($[5] || _1('div',$,5,2).flag('tool').flag('cog').dataset('icon','mcog').on$(0,['tap','showMenu'],this)).end()
			],1),
			$[6].bindData(this.space(),'explorerPanel',[]).setSpace(this.space()).end(),
			$[7].bindData(this.space(),'dependenciesPanel',[]).setSpace(this.space()).end()
		,true));
	};
})
exports.SidebarView = SidebarView;
