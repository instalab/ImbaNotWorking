function iter$(a){ return a ? (a.toArray ? a.toArray() : a) : []; };
var Imba = require('imba'), _2 = Imba.createTagList, _1 = Imba.createElement;
var UserAvatar = require('./UserAvatar').UserAvatar;
var Formatters$ = require('./Formatters'), TimeAgo = Formatters$.TimeAgo, Duration = Formatters$.Duration, ShortCount = Formatters$.ShortCount, Format = Formatters$.Format;
var Tile = require('./Tile').Tile;
var IconButton = require('uxa').IconButton;

var CastPreview = require('./CastPreview').CastPreview;
var CastMenu = require('./CastMenu').CastMenu;

var CastListItem = Imba.defineTag('CastListItem', function(tag){
	
	tag.Renderer = function (data,key){
		let key_, $ = this.$$ || (this.$$ = {}), $1;
		return ($[($1 = 'key$' + key)] || _1(CastListItem,$,$1,this)).setData(data).end();
	};
	
	tag.prototype.title = function (){
		var parent_;
		return this.data().title || (parent_ = this.data().parent()) && parent_.title;
	};
	
	tag.prototype.desc = function (){
		return ("[" + this.title() + "](" + (this.data().url()) + ")");
	};
	
	tag.prototype.render = function (){
		var $ = this.$;
		if (!(this.data().v > 0 && (!this.data().CODE || this.data().CODE == 200))) { return };
		
		var user = this.api().get(this.data().uid);
		var uname = user ? ((user.name || user.username)) : "User";
		
		return this.$open(0).setFlag(-1,this.data().id).setFlag(-2,this.data().type).setFlag(-3,this.data().privacy).setChildren($.$ = $.$ || [
			_1('div',$,0,this).flag('actions').flag('sm').setContent($[1] || _1(IconButton,$,1,0).flag('inspect').setIcon('*'),2),
			_1('div',$,2,this).flag('main').setContent([
				_1('div',$,3,2).flag('text'),
				_1('div',$,4,2).flag('c1').flag('muted').setContent([
					"Created ",
					$[5] || _1(TimeAgo,$,5,4).flag('date')
				],2)
			],2)
		],2).synced((
			$[1].setAction(['castmenu',this.data()]).end(),
			$[3].setNestedAttr('uxa','md',this.desc()).end(),
			$[5].bindData(this.data(),'created_at').end()
		,true));
	};
})
exports.CastListItem = CastListItem;

var Progress = Imba.defineTag('Progress', function(tag){
	tag.prototype.__value = {watch: 'valueDidSet',name: 'value'};
	tag.prototype.value = function(v){ return this._value; }
	tag.prototype.setValue = function(v){
		var a = this.value();
		if(v != a) { this._value = v; }
		if(v != a) { this.valueDidSet && this.valueDidSet(v,a,this.__value) }
		return this;
	};
	
	tag.prototype.valueDidSet = function (val){
		let pct = parseInt(Math.min(1,Math.max(0.05,val)) * 100);
		return this.css('width',pct + '%');
	};
});

var CastTile = Imba.defineTag('CastTile', Tile, function(tag){
	
	tag.reg('c');
	
	tag.Renderer = function (data,key,context){
		let key_, $ = this.$$ || (this.$$ = {}), $1;
		return ($[($1 = 'key$' + key)] || _1(CastTile,$,$1,this)).setData(data).setContext(context).end();
	};
	
	tag.prototype.context = function(v){ return this._context; }
	tag.prototype.setContext = function(v){ this._context = v; return this; };
	
	tag.prototype.cast = function (){
		return this.data();
	};
	
	tag.prototype.playlist = function (){
		return this.context();
	};
	
	tag.prototype.url = function (){
		if (this.playlist()) {
			return ("/p/" + (this.playlist().id) + "/" + (this.data().id));
		} else {
			return ("/c/" + (this.data().id));
		};
	};
	
	
	tag.prototype.canEdit = function (){
		return this.data().uid == this.api().uid() || this.api().isMod();
	};
	
	tag.prototype.showMenu = function (e){
		return e.uxa().open((_1(CastMenu)).bindData(this,'data',[]).setContext(this.context()).end());
	};
	
	tag.prototype.abstract = function (){
		let desc = (this.data().description || '');
		return desc.slice(0,desc.indexOf('\n\n'));
	};
	
	tag.prototype.desc = function (){
		return ("# [" + (this.data().title) + "](" + this.url() + ")\n" + this.abstract());
	};
	
	tag.prototype.render = function (){
		var $ = this.$, self = this;
		var cast = self.cast();
		var viewing = cast.viewing(self.api().uid());
		
		if (!(cast.v > 0 && (!self.data().CODE || self.data().CODE == 200))) { return };
		
		var user = self.api().get(self.data().uid);
		var o = self.options();
		var uname = user ? ((user.name || user.username)) : "User";
		
		return self.$open(0).setFlag(-1,self.data().id).setFlag(-2,self.data().type).setFlag(-3,self.data().privacy).setFlag(-4,self.data().topic_id).flagIf('mine',(self.data().uid == self.api().uid())).flagIf('draft',(self.data().isDraft())).setChildren($.$ = $.$ || [
			_1(CastPreview,$,0,self).flag('figure'),
			// if user and $web$
			// 	<a.avatar href=user.url> <img.Avatar src=user.avatarUrl(64)>
			_1(Progress,$,1,self),
			_1('div',$,2,self).flag('summary').flag('abs')
		],2).synced((
			$[0].bindData(self,'data',[]).setType(self.data().type).end(),
			$[1].setValue((viewing && viewing.progress),1).end(),
			$[2].setContent([
				self.data().hashtags ? (
					($[3] || _1('div',$,3,2).flag('hashtags')).setContent((function tagLoop($0) {
						for (let i = 0, items = iter$(self.data().hashtags), len = $0.taglen = items.length, item; i < len; i++) {
							item = items[i];
							($0[i] || _1('a',$0,i).flag('hashtag')).setFlag(0,item.slice(1)).setHref(("/t/" + item.slice(1))).setContent(item,3).end();
						};return $0;
					})($[4] || _2($,4,$[3])),4)
				) : void(0),
				($[5] || _1('div',$,5,2).flag('title').setContent($[6] || _1('a',$,6,5),2)).end((
					$[6].setHref(self.url()).setContent(self.data().isFork() ? ((self.data().parent() && self.data().parent().title)) : self.data().title,3).end()
				,true)),
				($[7] || _1('div',$,7,2).flag('credits').flag('muted').flag('bullets')).setContent([
					self.data().isDraft() ? (
						($[8] || _1('span',$,8,7).flag('pill').flag('draft').setText("DRAFT"))
					) : void(0),
					($[9] || _1('span',$,9,7).flag('pill').flag('type')).setFlag(0,self.data().type),
					($[10] || _1('span',$,10,7).flag('user')).setContent(
						// <span> "By "
						user ? (
							($[11] || _1('a',$,11,10)).setHref(user.url()).setContent(uname,3).end()
						) : void(0)
					,3),
					self.data().duration ? (
						($[12] || _1('span',$,12,7).flag('duration')).setContent(Format.duration(self.data().duration),3)
					) : void(0),
					
					self.data().published_at ? (
						($[13] || _1('span',$,13,7).flag('age')).setContent(Format.timeAgo(self.data().published_at),3)
					) : void(0),
					
					self.data().can(self.api().user(),'edit') ? (
						($[14] || _1('span',$,14,7).setContent($[15] || _1('span',$,15,14).flag('tool').dataset('icon','mcog').on$(0,['tap','stop','showMenu'],self),2)).end((
							$[15].end()
						,true))
					) : void(0)
				],1)
			],1)
		,true));
	};
})
exports.CastTile = CastTile;

