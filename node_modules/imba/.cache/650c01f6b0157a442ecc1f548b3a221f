var Imba = require('imba'), _1 = Imba.createElement;
var uxa$ = require('uxa'), Dialog = uxa$.Dialog, TextField = uxa$.TextField;

var defaultBodies = {};

defaultBodies.html = "<html>\n    <head></head>\n    <body>\n        \n    </body>\n</html>";

defaultBodies.css = ("body \{ \}");

defaultBodies.imba = "# FILENAME";

var NewFileDialog = Imba.defineTag('NewFileDialog', Dialog, function(tag){
	
	tag.prototype.space = function (){
		return this.data();
	};
	
	tag.prototype.onuxasubmit = function (e){
		var self = this;
		return self.uxa().queue().add(200,function() {
			return new Promise(function(resolve,reject) {
				var config = self.formData();
				var name = config.name;
				
				if (!name || self.space().files().any(function(f) { return f.name() == name; })) {
					return reject("File already exists");
				};
				
				var ext = name.split(".").pop();
				var body = (defaultBodies[ext] || "").replace("FILENAME",name);
				
				var widget = {
					type: 'file',
					name: name,
					body: body
				};
				
				var file = self.space().createWidget(widget).widget();
				console.log("returned file",file);
				self.space().agent().setFile(file);
				self.space().agent().setFocus(file);
				return resolve(file);
			});
		});
	};
	
	tag.prototype.body = function (){
		let $ = this.$$ || (this.$$ = {}), t0;
		return (t0 = this._body = this._body||(t0=_1('div',this)).flag('body').setContent([
			_1('h1',t0.$,'A',t0).setText("New file"),
			_1(TextField,t0.$,'B',t0).flag('autofocus').setName('name').setLabel("Name your new file").setType('text').setPlaceholder('index.js')
		],2)).end((
			t0.$.B.end()
		,true));
	};
})
exports.NewFileDialog = NewFileDialog;
