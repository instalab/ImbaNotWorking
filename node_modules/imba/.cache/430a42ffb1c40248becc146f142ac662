var Imba = require('imba'), _1 = Imba.createElement;
var Slider = Imba.defineTag('Slider', function(tag){
	
	tag.prototype.name = function(v){ return this._name; }
	tag.prototype.setName = function(v){ this._name = v; return this; };
	tag.prototype.__min = {'default': 0,name: 'min'};
	tag.prototype.min = function(v){ return this._min; }
	tag.prototype.setMin = function(v){ this._min = v; return this; }
	tag.prototype._min = 0;
	tag.prototype.__max = {'default': 1,name: 'max'};
	tag.prototype.max = function(v){ return this._max; }
	tag.prototype.setMax = function(v){ this._max = v; return this; }
	tag.prototype._max = 1;
	tag.prototype.__step = {'default': 0.01,name: 'step'};
	tag.prototype.step = function(v){ return this._step; }
	tag.prototype.setStep = function(v){ this._step = v; return this; }
	tag.prototype._step = 0.01;
	tag.prototype.__value = {watch: 'valueDidSet',name: 'value'};
	tag.prototype.value = function(v){ return this._value; }
	tag.prototype.setValue = function(v){
		var a = this.value();
		if(v != a) { this._value = v; }
		if(v != a) { this.valueDidSet && this.valueDidSet(v,a,this.__value) }
		return this;
	};
	
	tag.prototype.valueDidSet = function (value){
		var rel = this.relativeValue(value);
		var thumbval = (rel * 100).toFixed(0) + '%';
		var barval = (-100 + rel * 100).toFixed(0) + '%';
		var key = this.isVertical() ? 'bottom' : 'left';
		var trx = this.isVertical() ? (("translateY(" + thumbval + ")")) : (("translateX(-" + thumbval + ")"));
		
		(this._thumb || this.thumb()).css(key,thumbval);
		(this._thumb || this.thumb()).css('transform',trx);
		(this._bar || this.bar()).css(key,barval);
		if (this._vstr) {
			this._vstr.setText(this.displayValue(value));
		};
		return this;
	};
	
	
	tag.prototype.relativeValue = function (val){
		if(val === undefined) val = this.value();
		return (val - this.min()) / (this.max() - this.min());
	};
	
	tag.prototype.steppedValue = function (val){
		var round = 1 / this.step();
		return Math.round(val * round) / round;
	};
	
	tag.prototype.displayValue = function (val){
		if(val === undefined) val = this.value();
		return this.value();
	};
	
	tag.prototype.thumb = function (){
		let $ = this.$$ || (this.$$ = {}), t0;
		return (t0 = this._thumb = this._thumb||(t0=_1('div',this)).flag('thumb').setContent([
			_1('img',t0.$,'A',t0).setSrc("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"),
			this._vstr = this._vstr||_1('span',t0).flag('vstr')
		],2)).end((
			t0.$.A.end()
		,true));
	};
	
	tag.prototype.bar = function (){
		let $ = this.$$ || (this.$$ = {});
		return (this._bar = this._bar||_1('div',this).flag('bar'));
	};
	
	tag.prototype.isVertical = function (){
		return (this._isVertical == null) ? (this._isVertical = this.hasFlag('vertical')) : this._isVertical;
	};
	
	tag.prototype.ontouchstart = function (t){
		var self = this;
		var e = t.event();
		self._box = self.dom().getBoundingClientRect();
		self._lx = t.x() - self._box.left;
		self._ly = t.y() - self._box.top;
		self._ow = self._box.width; // dom:offsetWidth
		self._oh = self._box.height; // dom:offsetHeight
		self.setValue = function() { return self; };
		t.capture();
		return self.ontouchupdate(t);
	};
	
	tag.prototype.ontouchupdate = function (t){
		// var val = isVertical ? ()
		if (this.isVertical()) {
			return this.update((this._oh - (this._ly + t.dy())) / this._oh);
		} else {
			return this.update((this._lx + t.dx()) / this._ow);
		};
	};
	
	tag.prototype.ontouchend = function (t){
		var v_;
		this.trigger('change');
		(((v_ = this.setValue),delete this.setValue, v_));
		return this;
	};
	
	tag.prototype.update = function (val){
		val = Math.max(Math.min(1,val),0);
		val = this.steppedValue(((this.max() - this.min()) * val) + this.min());
		// console.log "update",val,max,min
		// manually setting value
		this.valueDidSet(this._value = val);
		return this.trigger('changeslider',{value: val});
	};
	
	tag.prototype.ontap = function (e){
		return e.halt();
	};
	
	tag.prototype.render = function (){
		var $ = this.$;
		return this.$open(0).setChildren(
			$[0] || _1('div',$,0,this).flag('track')
		,2).synced((
			$[0].setContent([
				$[1] || _1('div',$,1,0).flag('bar-track'),
				this.thumb()
			],1).end((
				$[1].setContent(this.bar(),3)
			,true))
		,true));
	};
})
exports.Slider = Slider;
