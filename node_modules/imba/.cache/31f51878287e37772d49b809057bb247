function iter$(a){ return a ? (a.toArray ? a.toArray() : a) : []; };
var Imba = require('imba'), _1 = Imba.createElement;

var uxa$ = require('uxa'), Menu = uxa$.Menu, MenuItem = uxa$.MenuItem;

var DependencyAddDialog = require('./DependencyAddDialog').DependencyAddDialog;
var CastDialog = require('../../site/components/CastDialog').CastDialog;

var SpaceMenu = Imba.defineTag('SpaceMenu', Menu, function(tag){
	
	tag.prototype.space = function (){
		return this.data();
	};
	
	tag.prototype.hide = function (){
		return this.trigger('uxa:hide');
	};
	
	tag.prototype.ontap = function (e){
		return this.hide();
	};
	
	tag.prototype.newFile = function (e){
		var name = window.prompt("Name file");
		if (name) { return this.space().fs().mkfile(name) };
	};
	
	tag.prototype.newDirectory = function (e){
		var name = window.prompt("Name directory");
		if (name) { return this.space().fs().mkdir(name) };
	};
	
	tag.prototype.addDependency = function (){
		return this.uxa().open((_1(DependencyAddDialog)).bindData(this,'space',[]).end());
	};
	
	tag.prototype.importDependenciesFromFile = function (){
		var self = this;
		var fileInput = (_1('input').setType("file")).end();
		
		fileInput.dom().onchange = async function() {
			for (let i = 0, items = iter$(fileInput.dom().files), len = items.length, file; i < len; i++) {
				file = items[i];
				if (file.name == 'package.json') {
					var body = await self.readTextFile(file);
					var parsed = JSON.parse(body);
					// TODO: show spinner
					self.space().browser().overwritePackages(parsed.dependencies);
				} else {
					// uhm?
				};
			};
			return Imba.commit();
		};
		
		return fileInput.dom().click();
	};
	
	
	tag.prototype.editCastDetails = function (){
		return this.uxa().open((_1(CastDialog).flag('modal')).bindData(this.space(),'model',[]).setFormData(this.space().model()).end());
	};
	
	tag.prototype.render = function (){
		var $ = this.$;
		var canEdit = this.space().model().can(this.api().user(),'edit');
		return this.$open(0).flag('space-menu').setChildren([
			canEdit ? Imba.static([
				($[0] || _1('div',$,0,this).flag('action').on$(0,['tap','editCastDetails'],this).setText("Edit metadata")),
				// <.action :tap.editCastDetails> "Edit metadata"
				// <MenuItem[space.model] action='castedit' label="Edit metadata" data-icon='madd'>
				this.space().model().isPublished() ? (
					($[1] || _1(MenuItem,$,1,this).setAction('branchpublish').setLabel("Re-publish")).bindData(this.space(),'trunk',[]).end()
				) : void(0),
				($[2] || _1('hr',$,2,this))
			],1,1) : void(0),
			($[3] || _1('div',$,3,this).flag('action').on$(0,['tap','newFile'],this).setText("New File...")),
			($[4] || _1('div',$,4,this).flag('action').on$(0,['tap','newDirectory'],this).setText("New Folder...")),
			($[5] || _1('div',$,5,this).flag('action').on$(0,['tap','addDependency'],this).setText("Add dependency...")),
			($[6] || _1('div',$,6,this).flag('action').on$(0,['tap','importDependenciesFromFile'],this).setText("Import package.json")),
			
			canEdit ? Imba.static([
				($[7] || _1('hr',$,7,this)),
				($[8] || _1(MenuItem,$,8,this).setAction('importslides').setLabel("Import Google Slides")).end(),
				this.space().slides().url() ? (
					($[9] || _1(MenuItem,$,9,this).setAction('reimportslides').setLabel("Resync with Google Slides")).end()
				) : void(0)
			],1,2) : void(0),
			($[10] || _1('hr',$,10,this)),
			($[11] || _1(MenuItem,$,11,this).setAction('spacezip').setLabel("Download .zip")).end(),
			($[12] || _1(MenuItem,$,12,this).setAction('spaceclone').setLabel("Clone workspace")).end()
		],1).synced();
	};
})
exports.SpaceMenu = SpaceMenu;
