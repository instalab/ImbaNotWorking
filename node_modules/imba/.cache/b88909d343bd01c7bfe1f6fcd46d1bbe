var fetch = require('node-fetch');

function Mailchimp(key){
	this._key = key;
	this._dc = key.split('-')[1];
	this._base = ("https://" + (this._dc) + ".api.mailchimp.com/3.0");
	this._auth = new Buffer(("user:" + (this._key))).toString("base64");
};

exports.Mailchimp = Mailchimp; // export class 
Mailchimp.prototype.key = function(v){ return this._key; }
Mailchimp.prototype.setKey = function(v){ this._key = v; return this; };
Mailchimp.prototype.base = function(v){ return this._base; }
Mailchimp.prototype.setBase = function(v){ this._base = v; return this; };

Mailchimp.prototype.request = function (method,path,params){
	if(params === undefined) params = {};
	var opts = {
		method: method,
		body: JSON.stringify(params),
		headers: {
			'Accept': 'application/json',
			'Content-Type': 'application/json',
			'Authorization': ("Basic " + (this._auth))
		}
	};
	
	console.log(this.base() + path);
	return fetch(this.base() + path,opts).then(function(res) { return res.json(); });
};

Mailchimp.prototype.subscribe = function (listId,email,mergeFields){
	if(mergeFields === undefined) mergeFields = {};
	return this.request("POST",("/lists/" + listId + "/members"),{email_address: email,
	status: "subscribed",
	merge_fields: mergeFields});
};
